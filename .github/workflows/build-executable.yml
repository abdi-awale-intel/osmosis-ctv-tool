name: Build and Test Executable

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.13.1
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.1'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Create logo files
      run: |
        cd src/images
        python create_logos.py
    
    - name: Verify logo files exist
      run: |
        Get-ChildItem src/images/*.png
        Get-ChildItem src/images/*.jpg
    
    - name: Build executable with PyInstaller
      run: |
        pyinstaller ctvlist_gui_python3131.spec --clean --noconfirm
    
    - name: Test executable (basic import test)
      run: |
        # Test that the executable can at least start without critical errors
        # Run for a few seconds then terminate (GUI app)
        Start-Process -FilePath "dist/CTV_List_Data_Processor.exe" -PassThru | ForEach-Object { 
          Start-Sleep -Seconds 3
          Stop-Process -Id $_.Id -Force -ErrorAction SilentlyContinue
        }
        Write-Output "Executable test completed"
    
    - name: Check executable size
      run: |
        $size = (Get-Item "dist/CTV_List_Data_Processor.exe").Length / 1MB
        Write-Output "Executable size: $([math]::Round($size, 2)) MB"
        
    - name: Upload executable as artifact
      uses: actions/upload-artifact@v3
      with:
        name: CTV-List-Data-Processor-Windows
        path: dist/CTV_List_Data_Processor.exe
        retention-days: 7

  test-build-integrity:
    runs-on: windows-latest
    needs: build-windows
    steps:
    - name: Download executable
      uses: actions/download-artifact@v3
      with:
        name: CTV-List-Data-Processor-Windows
    
    - name: Verify executable integrity
      run: |
        if (Test-Path "CTV_List_Data_Processor.exe") {
          $size = (Get-Item "CTV_List_Data_Processor.exe").Length
          Write-Output "Downloaded executable size: $size bytes"
          Write-Output "✅ Executable integrity verified"
        } else {
          Write-Error "❌ Executable not found"
          exit 1
        }
